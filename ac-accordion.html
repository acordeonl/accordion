<imports >
    <link rel="import" href="../polymer/polymer.html">
    <link rel="import" href="./accordion-treble.html">
    <link rel="import" href="./accordion-bass.html">
    <link rel="import" href="../local-dom/local-dom.html">
    <link rel="import" href="../midi-manager/midi-manager.html">
    <link rel="import" href="../ac-recorder/ac-recorder.html">
    <link rel="import" href="../ac-player/ac-player.html">
    <script src="./audio_vars.js"></script>
    <script src="./synth_vars.js"></script>
</imports>
<dom-module id="ac-accordion">
    <template>
        <style>
            :host {
                outline: none;
                width: 60vw;
                height: 100%;
            }
            [wrapper] {
                height: 100%;
                width: 100%;
                @apply(--layout-horizontal);
                @apply(--layout-around-justified);
            }
            [accordion] {
                @apply(--layout-justified);
                @apply(--layout-center);
                height: 100%;
                width: 65%;
            }
            .reversed {
                @apply(--layout-horizontal-reverse);
            }
            .horizontal {
                @apply(--layout-horizontal);
            }
        </style>
        <ac-recorder ></ac-recorder>
        <ac-player instrument-activity-url="alicia_adorada" velocities-url="alicia_adorada_velocities"></ac-player>
        <midi-manager ></midi-manager>
        <local-dom mobile="{{mobile}}" tablet="{{tablet}}" laptop="{{laptop}}">
            <div wrapper>
                <template is="dom-if" if="[[laptop]]">
                    <div accordion class$="{{_computeRotation(rotation)}}">
                        <accordion-treble button-velocity="[[buttonVelocity]]" volume="[[trebleVolume]]" rotation=[[rotation]] tone="{{tone}}"></accordion-treble>
                        <accordion-bass button-velocity="[[buttonVelocity]]" volume="[[bassVolume]]" rotation=[[rotation]] tone="{{tone}}"></accordion-bass>
                    </div>
                </template>
                <template is="dom-if" if="[[!laptop]]">
                    <template is="dom-if" if="[[showingTreble]]">
                        <accordion-treble volume="[[trebleVolume]]" tone="{{tone}}" showing-treble=[[showingTreble]] rotation=[[rotation]] mobile></accordion-treble>
                    </template>
                    <template is="dom-if" if="[[!showingTreble]]">
                        <accordion-bass volume="[[bassVolume]]" tone="{{tone}}" showing-treble=[[showingTreble]] rotation=[[rotation]] mobile></accordion-bass>
                    </template>
                </template>
            </div>
        </local-dom>
    </template>
    <script>
        Polymer({
            is: "ac-accordion",
            observers: [],
            behaviors: [],
            listeners: {
                'keypress': '_keyPress',
                'keyup': '_keyUp',
                'note-on': '_buttonPress',
                'note-off': '_buttonRelease',
                'velocity-change': '_updateVelocity',
                'mousemove': '_updateOpening',
                'click': '_test'
            },
            properties: {
                recording: {
                    type: Boolean,
                    value: false
                },
                opening: {
                    type: Boolean,
                    value: false
                },
                buttonVelocity: {
                    type: Number,
                    value: 1
                },
                trebleVolume: {
                    type: Number,
                    value: 100
                },
                bassVolume: {
                    type: Number,
                    value: 60
                },
                rotation: {
                    type: Boolean,
                    value: false
                },
                tone: {
                    type: Number,
                    value: 0
                },
                showingTreble: {
                    type: Boolean,
                    value: true
                },
                bassNotes: {
                    type: Number,
                    value: 0
                },
                notesLoaded: {
                    type: Boolean,
                    value: false
                }
            },
            _test: function () {
                // this.$$('AC-PLAYER').updateTempo(40);
                // this.fire ("note-on" , {midiNote:24, time:5 , channel:0}) ;
                // this.fire ("note-off" , {midiNote:24, time:7 , channel:0}) ;
                this.fire ("note-on" , {midiNote:10,  time:5 , channel:3}) ;
                this.fire ("note-off" , {midiNote:10, time:8 , channel:3}) ;
            },
            _loop: function(){
                this._update() ;
                window.requestAnimationFrame(this._loop.bind(this));
            },
            _update: function(){
                this.$$("ACCORDION-TREBLE").update() ;
                this.$$("ACCORDION-BASS").update() ;
            },
            startRecording: function () {
                this.recording = true;
                this.$$('AC-RECORDER').startRecording();
            },
            pauseRecording: function () {
                this.recording = false;
                this.$$('AC-RECORDER').saveRecording();
            },
            play: function () {
                this.$$('AC-PLAYER').play();
            },
            pause: function () {
                this.$$('AC-PLAYER').pause();
            },
            _updateOpening: function (e) {
                if (e.movementX > 0)
                    this.opening = true;
                if (e.movementX < 0) {
                    this.opening = false;
                }
            },
            _keyPress: function (e) {
                this._keyAction(e.key, "note-on");
            },
            _keyUp: function (e) {
                this._keyAction(e.key, "note-off");
            },
            _keyAction: function (key, cmd) {
                var note = keyMap[key];
                if (note === undefined)
                    return;
                if (this.opening)
                    note++;
                this.fire(cmd, {
                    channel: 0,
                    midiNote: note,
                    velocity: 1
                });
            },
            _computeRotation: function (rotation) {
                if (rotation)
                    return "reversed";
                return "horizontal";
            },
            changeVolume: function (e) {
                this.trebleVolume = e.detail.trebleVolume;
                this.bassVolume = e.detail.bassVolume;
            },
            changePitch: function (diff) {
                this.$$("ACCORDION-TREBLE").changePitch(diff);
                this.$$("ACCORDION-BASS").changePitch(diff);
            },
            rotate: function () {
                this.rotation = !this.rotation;
            },
            toggleNotes: function () {
                this.$$("ACCORDION-TREBLE").toggleNotes();
                this.$$("ACCORDION-BASS").toggleNotes();
            },
            _updateVelocity: function (e) {
                if (this.recording && e.detail.fromPlayer === undefined)
                    this.$$('AC-RECORDER').addVelocityActivity(e.detail.velocity);
                this.buttonVelocity = (e.detail.velocity / 127);
            },
            _releaseAllChordButtons: function () {
                var st = this.bassNotes;
                var button = -1;
                //based on G accrdion with notes on bass: 41,43,45,46,48,49,50,51,52,53,54,55,56,57,58,59 bits represent: 41,42,43,44,45,46,47,48,49,50,51,52,53,54,55,56,57,58,59 s0 closed
                if ((st & (1 << 7)) && (st & (1 << 11)) && (st & (1 << 14)))
                    button = 0;

                //s0 opened
                if ((st & (1 << 7)) && (st & (1 << 10)) && (st & (1 << 14)))
                    button = 1;

                //s1 closed
                if ((st & (1 << 8)) && (st & (1 << 12)) && (st & (1 << 15)))
                    button = 2;

                //s1 opened
                if ((st & (1 << 8)) && (st & (1 << 11)) && (st & (1 << 15)))
                    button = 3;

                //s2 closed
                if ((st & (1 << 9)) && (st & (1 << 13)) && (st & (1 << 16)))
                    button = 4;

                //s2 opened
                if ((st & (1 << 9)) && (st & (1 << 12)) && (st & (1 << 16)))
                    button = 5;

                //s3 closed
                if ((st & (1 << 10)) && (st & (1 << 14)) && (st & (1 << 17)))
                    button = 6;

                //s3 opened
                if ((st & (1 << 10)) && (st & (1 << 13)) && (st & (1 << 17)))
                    button = 7;

                //s4 closed
                if ((st & (1 << 11)) && (st & (1 << 15)) && (st & (1 << 18)))
                    button = 8;

                //s4 opened
                if ((st & (1 << 11)) && (st & (1 << 14)) && (st & (1 << 18)))
                    button = 9;

                //s5 closed
                if ((st & (1 << 0)) && (st & (1 << 16)) && (st & (1 << 7)))
                    button = 10;

                //s5 opened
                if ((st & (1 << 0)) && (st & (1 << 15)) && (st & (1 << 7)))
                    button = 11;
                if (this.recording)
                    this.$$('AC-RECORDER').addInstrumentActivity("note-off", button, 3);
                this.$$('ACCORDION-BASS').chordButtonRelease(button);
            },
            _updateChordsButtons: function () {
                var st = this.bassNotes;
                var button = -1;
                //based on G accrdion with notes on bass: 41,43,45,46,48,49,50,51,52,53,54,55,56,57,58,59 bits represent: 41,42,43,44,45,46,47,48,49,50,51,52,53,54,55,56,57,58,59 this.$.trebleSynthesizer.allNotesOffChords(); s0 closed
                if ((st & (1 << 7)) && (st & (1 << 11)) && (st & (1 << 14)))
                    button = 0;

                //s0 opened
                if ((st & (1 << 7)) && (st & (1 << 10)) && (st & (1 << 14)))
                    button = 1;

                //s1 closed
                if ((st & (1 << 8)) && (st & (1 << 12)) && (st & (1 << 15)))
                    button = 2;

                //s1 opened
                if ((st & (1 << 8)) && (st & (1 << 11)) && (st & (1 << 15)))
                    button = 3;

                //s2 closed
                if ((st & (1 << 9)) && (st & (1 << 13)) && (st & (1 << 16)))
                    button = 4;

                //s2 opened
                if ((st & (1 << 9)) && (st & (1 << 12)) && (st & (1 << 16)))
                    button = 5;

                //s3 closed
                if ((st & (1 << 10)) && (st & (1 << 14)) && (st & (1 << 17)))
                    button = 6;

                //s3 opened
                if ((st & (1 << 10)) && (st & (1 << 13)) && (st & (1 << 17)))
                    button = 7;

                //s4 closed
                if ((st & (1 << 11)) && (st & (1 << 15)) && (st & (1 << 18)))
                    button = 8;

                //s4 opened
                if ((st & (1 << 11)) && (st & (1 << 14)) && (st & (1 << 18)))
                    button = 9;

                //s5 closed
                if ((st & (1 << 0)) && (st & (1 << 16)) && (st & (1 << 7)))
                    button = 10;

                //s5 opened
                if ((st & (1 << 0)) && (st & (1 << 15)) && (st & (1 << 7)))
                    button = 11;
                if (this.recording)
                    this.$$('AC-RECORDER').addInstrumentActivity("note-on", button, 3);
                this.$$('ACCORDION-BASS').chordButtonPress(button);
            },
            _buttonAction: function(e,which,cmd){
                var button  = e.detail.midiNote ;
                if(e.detail.channel !== 3)
                    button = which==='TREBLE'? e.detail.midiNote-24: e.detail.midiNote-48;

                if (e.detail.time) {
                    var action = {} ;
                    action.time = e.detail.time ;
                    action.state = (cmd ==='on')? (button % 2) + 1:0;
                    if(e.detail.channel === 3 )
                        this.$$('ACCORDION-'+which).addChordButtonAction(button ,action) ;
                    else
                        this.$$('ACCORDION-'+which).addButtonAction(button ,action) ;
                }
                else {
                    if(e.detail.channel === 3) {
                        if(cmd==='on')
                            this.$$('ACCORDION-'+which).chordButtonPress(button);
                        else
                            this.$$('ACCORDION-'+which).chordButtonRelease(button);
                    }
                    else {
                        if ( cmd === 'on')
                            this.$$('ACCORDION-'+which).buttonPress(button);
                        else
                            this.$$('ACCORDION-'+which).buttonRelease(button);
                    }
                }
            },
            _buttonPress: function (e) {
                if (this.recording && e.detail.fromPlayer === undefined && e.detail.channel !== 2)
                    this.$$('AC-RECORDER').addInstrumentActivity("note-on", e.detail.midiNote, e.detail.channel);

                if (e.detail.channel === 0) {
                    this._buttonAction(e,'TREBLE','on') ;
                } else if (e.detail.channel === 1) {
                    this._buttonAction(e,'BASS','on') ;
                } else if (e.detail.channel === 2) {
                    var cnt = (this._bitCount(this.bassNotes) % 3);
                    if (cnt === 0) {
                        this._releaseAllChordButtons();
                    }
                    var bNote = e.detail.midiNote - 41;
                    this.bassNotes = this.bassNotes | (1 << bNote);
                    cnt = (this._bitCount(this.bassNotes) % 3);
                    if (cnt === 0) {
                        this._updateChordsButtons();
                    }
                }
                else if(e.detail.channel ===3 ) {
                    this._buttonAction(e,'BASS','on') ;
                }
            },
            _buttonRelease: function (e) {
                if (this.recording && e.detail.fromPlayer === undefined && e.detail.channel !== 2)
                    this.$$('AC-RECORDER').addInstrumentActivity("note-off", e.detail.midiNote, e.detail.channel);

                if (e.detail.channel === 0) {
                    this._buttonAction(e,'TREBLE','off') ;
                } else if (e.detail.channel === 1) {
                    this._buttonAction(e,'BASS','off') ;
                } else if (e.detail.channel === 2) {
                    var cnt = (this._bitCount(this.bassNotes) % 3);
                    if (cnt === 0) {
                        this._releaseAllChordButtons();
                    }
                    var bNote = e.detail.midiNote - 41;
                    var tmp = 524287 ^ (1 << bNote);
                    this.bassNotes = this.bassNotes & tmp;
                    cnt = (this._bitCount(this.bassNotes) % 3);
                    if (cnt === 0) {
                        this._updateChordsButtons();
                    }
                }
                else if(e.detail.channel === 3 ) {
                    this._buttonAction(e,'BASS','off') ;
                }
            },
            _bitCount: function (num) {
                var cnt = 0;
                for (var i = 0; i < 31; i++) {
                    if (num & (1 << i))
                        cnt++;
                    }
                return cnt;
            },
            requestConvolver: function (url) {
                var convolverRequest = new XMLHttpRequest();
                convolverRequest.open('GET', url, true);
                convolverRequest.responseType = 'arraybuffer';
                convolverRequest.onload = function () {
                    context.decodeAudioData(convolverRequest.response, function (buffer) {
                        convolver.buffer = buffer;
                    });
                };
                convolverRequest.send();
            },
            swap: function () {
                this.showingTreble = !this.showingTreble;
            },
            ready: function () {
                Polymer.RenderStatus.afterNextRender(this, function () {
                    this._loop() ;
                    this.requestConvolver("/data/16_IR_Pool_Size_00.wav");
                });
            }
        });
    </script>
</dom-module>

<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="./accordion-treble.html">
<link rel="import" href="./accordion-bass.html">
<link rel="import" href="../local-dom/local-dom.html">
<link rel="import" href="../midi-manager/midi-manager.html">
<link rel="import" href="../ac-synthesizer/ac-synthesizer.html">
<!-- <script src="./vars.js"></script> -->
<dom-module id="ac-accordion">
    <template>
        <style>
            :host {
                width: 60vw;
                height: 100%;
            }
            [wrapper] {
                height: 100%;
                width: 100%;
                @apply(--layout-horizontal);
                @apply(--layout-around-justified);
            }
        </style>
        <ac-synthesizer lowpass-value="20000" dry-value="1.3" wet-value="1.35" notes-url="/data/accordion_synth.mp3" id="trebleSynthesizer"></ac-synthesizer>
        <!-- <ac-synthesizer  lowpass-value="4000" dry-value="1.3" wet-value="0.2" notes-url="/data/accordion_bass_notes.mp3" id="bassSynthesizer"></ac-synthesizer> -->
            <!-- <ac-synthesizer  lowpass-value="4000" dry-value="1.3" wet-value="0.2"  notes-url="/data/accordion_bass_chords.mp3" id="bassChordsSynthesizer"></ac-synthesizer> -->
        <midi-manager on-note-on='_noteOn' on-note-off='_noteOff' on-velocity-change="_updateVelocity"></midi-manager>
        <local-dom mobile="{{mobile}}" tablet="{{tablet}}" laptop="{{laptop}}">
            <div wrapper>
                <template is="dom-if" if="[[laptop]]">
                    <accordion-treble></accordion-treble>
                    <accordion-bass></accordion-bass>
                </template>
                <template is="dom-if" if="[[!laptop]]">
                    <template is="dom-if" if="[[showingTreble]]">
                        <accordion-treble showing-treble=[[showingTreble]] mobile></accordion-treble>
                    </template>
                    <template is="dom-if" if="[[!showingTreble]]">
                        <accordion-bass showing-treble=[[showingTreble]] mobile></accordion-bass>
                    </template>
                    <template is="dom-if" if="[[mobileLandscape]]">
                        <accordion-bass showing-treble=[[showingTreble]] mobile></accordion-bass>
                    </template>
                </template>
            </div>
        </local-dom>
    </template>
    <script>
        var gAccordion = [
            51,
            49,
            36,
            40,
            41,
            43,
            45,
            46,
            48,
            50,
            53,
            52,
            57,
            55,
            60,
            58,
            65,
            62,
            69,
            64,
            42,
            44,
            31,
            35,
            36,
            38,
            40,
            41,
            43,
            45,
            48,
            47,
            52,
            50,
            55,
            53,
            60,
            57,
            64,
            59,
            67,
            62,
            37,
            39,
            31,
            33,
            35,
            36,
            38,
            40,
            43,
            42,
            47,
            45,
            50,
            48,
            55,
            52,
            59,
            54,
            62,
            57
        ];
        var gAccordionBass = [
            55,
            50,
            48,
            55,
            53,
            48,
            52,
            57,
            57,
            50,
            58,
            58
        ];
        var marked = [];
        var noteCnt = 0;
        var bassNotesPlayed = [];
        var newName = [];
        function sortNumber(a, b) {
            return a - b;
        }
        function createArray(length) {
            var arr = new Array(length || 0),
                i = length;
            if (arguments.length > 1) {
                var args = Array.prototype.slice.call(arguments, 1);
                while (i--)
                    arr[length - 1 - i] = createArray.apply(this, args);
                }
            return arr;
        }
        Polymer({
            is: "ac-accordion",
            observers: [],
            behaviors: [],
            listeners: {
                'click': 'test'
            },
            properties: {
                showingTreble: {
                    type: Boolean,
                    value: true
                },
                bassNotes: {
                    type: Number,
                    value: 0
                },
                bassNotesTest: {
                    type: Number
                }
            },
            _updateVelocity: function (e) {
                this.$.trebleSynthesizer.updateVelocity(e.detail.velocity);
                // this.$.bassSynthesizer.updateVelocity(e.detail.velocity);
                // this.$.bassChordsSynthesizer.updateVelocity(e.detail.velocity);
            },
            _allNotesOff: function () {
                for (var i = 0; i < 12; i++) {
                    this.$$('ACCORDION-BASS').chordNoteOff(i);
                }
            },
            _updateChords: function () {
                var st = this.bassNotes;
                //based on G accrdion with notes on bass: 41,43,45,46,48,49,50,51,52,53,54,55,56,57,58,59 bits represent: 41,42,43,44,45,46,47,48,49,50,51,52,53,54,55,56,57,58,59
                this.$.trebleSynthesizer.allNotesOffChords();
                //s0 closed
                if ((st & (1 << 7)) && (st & (1 << 11)) && (st & (1 << 14))) {
                    this.$$('ACCORDION-BASS').chordNoteOn(0);
                    this.$.trebleSynthesizer.noteOn(69+12+35);
                }
                //s0 opened
                if ((st & (1 << 7)) && (st & (1 << 10)) && (st & (1 << 14))) {
                    this.$$('ACCORDION-BASS').chordNoteOn(1);
                    this.$.trebleSynthesizer.noteOn(69+12+26);
                }
                //s1 closed
                if ((st & (1 << 8)) && (st & (1 << 12)) && (st & (1 << 15))) {
                    this.$.trebleSynthesizer.noteOn(69+12+15);
                    this.$$('ACCORDION-BASS').chordNoteOn(2);
                }
                //s1 opened
                if ((st & (1 << 8)) && (st & (1 << 11)) && (st & (1 << 15))) {
                    this.$.trebleSynthesizer.noteOn(69+12+35);
                    this.$$('ACCORDION-BASS').chordNoteOn(3);
                }
                //s2 closed
                if ((st & (1 << 9)) && (st & (1 << 13)) && (st & (1 << 16))) {
                    this.$.trebleSynthesizer.noteOn(69+12+22);
                    this.$$('ACCORDION-BASS').chordNoteOn(4);
                }
                //s2 opened
                if ((st & (1 << 9)) && (st & (1 << 12)) && (st & (1 << 16))) {
                    this.$.trebleSynthesizer.noteOn(69+12+15);
                    this.$$('ACCORDION-BASS').chordNoteOn(5);
                }
                //s3 closed
                if ((st & (1 << 10)) && (st & (1 << 14)) && (st & (1 << 17))) {
                    this.$.trebleSynthesizer.noteOn(69+12+41);
                    this.$$('ACCORDION-BASS').chordNoteOn(6);
                }
                //s3 opened
                if ((st & (1 << 10)) && (st & (1 << 13)) && (st & (1 << 17))) {
                    this.$.trebleSynthesizer.noteOn(69+12+3);
                    this.$$('ACCORDION-BASS').chordNoteOn(7);
                }
                //s4 closed
                if ((st & (1 << 11)) && (st & (1 << 15)) && (st & (1 << 18))) {
                    this.$.trebleSynthesizer.noteOn(69+12+5);
                    this.$$('ACCORDION-BASS').chordNoteOn(8);
                }
                //s4 opened
                if ((st & (1 << 11)) && (st & (1 << 14)) && (st & (1 << 18))) {
                    this.$.trebleSynthesizer.noteOn(69+12+24);
                    this.$$('ACCORDION-BASS').chordNoteOn(9);
                }
                //s5 closed
                if ((st & (1 << 0)) && (st & (1 << 16)) && (st & (1 << 7))) {
                    this.$.trebleSynthesizer.noteOn(69+12+9);
                    this.$$('ACCORDION-BASS').chordNoteOn(10);
                }
                //s5 opened
                if ((st & (1 << 0)) && (st & (1 << 15)) && (st & (1 << 7))) {
                    this.$.trebleSynthesizer.noteOn(69+12+9);
                    this.$$('ACCORDION-BASS').chordNoteOn(11);
                }
            },
            _noteOn: function (e) {
                if (e.detail.channel === 0) {
                    this.$.trebleSynthesizer.noteOn(gAccordion[e.detail.midiNote - 24]-29+24);
                    this.$$('ACCORDION-TREBLE').noteOn(e.detail.midiNote - 24);
                } else if (e.detail.channel === 1) {
                    this.$$('ACCORDION-BASS').noteOn(e.detail.midiNote - 48);
                    this.$.trebleSynthesizer.noteOn(gAccordionBass[e.detail.midiNote - 48]-48+69);
                    // console.log("note on bass " + (gAccordionBass[e.detail.midiNote - 48]-48+69));
                    // this.$.bassSynthesizer.noteOn(gAccordionBass[e.detail.midiNote - 48] - 48);
                } else if (e.detail.channel === 2) {
                    var note = e.detail.midiNote - 41;
                    this.bassNotes = this.bassNotes | (1 << note);
                    var noteTest = e.detail.midiNote - 29;
                    this.bassNotesTest = this.bassNotesTest | (1 << noteTest);
                    if (this._bitCount(this.bassNotesTest) === 3) {
                        // console.log("nN " + newName[this.bassNotesTest]);
                        if (!marked[this.bassNotesTest]) {
                            marked[this.bassNotesTest] = true;
                            bassNotesPlayed.push(this.bassNotesTest);
                        }
                    }
                    this._allNotesOff();
                    this._updateChords();
                }
            },
            _noteOff: function (e) {
                if (e.detail.channel === 0) {
                    this.$$('ACCORDION-TREBLE').noteOff(e.detail.midiNote - 24);
                    this.$.trebleSynthesizer.noteOff(gAccordion[e.detail.midiNote - 24]-29+24);
                } else if (e.detail.channel === 1) {
                    this.$$('ACCORDION-BASS').noteOff(e.detail.midiNote - 48);
                    this.$.trebleSynthesizer.noteOff(gAccordionBass[e.detail.midiNote - 48]-48+69);

                    // this.$.bassSynthesizer.noteOff(gAccordionBass[e.detail.midiNote - 48] - 48);
                } else if (e.detail.channel === 2) {
                    var note = e.detail.midiNote - 41;
                    var tmp = 524287 ^ (1 << note);
                    this.bassNotes = this.bassNotes & tmp;
                    var noteTest = e.detail.midiNote - 29;
                    var tmpTest = 2147483647 ^ (1 << noteTest);
                    this.bassNotesTest = this.bassNotesTest & tmpTest;
                    this._allNotesOff();
                    this._updateChords();
                }
            },
            _bitCount: function(num){
                var cnt = 0 ;
                for(var i = 0 ; i < 31 ;i ++ ) {
                    if(num&(1<<i))
                        cnt ++ ;
                }
                return cnt ;
            },
            test: function () {
                this.$$('ACCORDION-BASS').chordNoteOn(0);
                this.$.trebleSynthesizer.noteOn(69+12+35);
                // this.$$('ACCORDION-BASS').chordNoteOn(11);
                // bassNotesPlayed.sort(sortNumber);
                // console.log("len " + bassNotesPlayed.length);
                // for (var i = 0; i < bassNotesPlayed.length; i++) {
                //     console.log(bassNotesPlayed[i]);
                //     newName[bassNotesPlayed[i]] = i;
                // }
                // console.log("coleto");
                // this.$.bassSynthesizer.updateVelocity(15) ;
                // this.$.bassChordsSynthesizer.updateVelocity(15) ;
            },
            swap: function () {
                this.showingTreble = !this.showingTreble;
            }
        });
    </script>
</dom-module>

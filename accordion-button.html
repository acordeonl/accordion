<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../iron-image/iron-image.html">
<!--

Shows drop down menu (works on chrome)

### Usage
The list displayed in the drop down menu can be set as an attribute.

    <drop-menu list-items='["first" ,"second"]'></drop-menu>

For an overlayed drop menu:

    <drop-menu overlay-menu list-items='["first" ,"second"]'></drop-menu>

### Styling
 Custom property | Description | Default
----------------|-------------|----------
`--item-background-color` | List item backround color | `#f1ecef`
`--item-color` | List item color used for fonts | `#302f31`
`--close-color` | Icon button hover color | `4775D1`
`--content-background` | Drop menu's background color | `white`
`--close-color` | Icon button hover color | `4775D1`
`--icon-button` | Mixin applied the icon button | `{}`

@demo demo/drop-menu-demo.html
-->
<dom-module id="accordion-button">
    <template>
        <style>
            :host {}
            .bass_chord {
                margin-top: -0.6vh;
                user-select: none;
                height: 5.4vh;
                width: 5.4vh;
            }
            .bass_note {
                margin-top: -0.6vh;
                user-select: none;
                height: 5.4vh;
                width: 5.4vh;
            }
            .treble {
                user-select: none;
                margin-top: -0.6vh;
                height: 6.8vh;
                width: 6.8vh;
            }
            [circle] {
                background-color: var(--content-background);
                border-radius: 100%;
            }
            [circle]:hover{
                cursor: pointer;
            }
            [shadow] {
                @apply(--layout-center-justified);
                @apply(--layout-vertical);
                @apply(--layout-center);
                background-color: #e4e4e4;
                /*background-color: #f1ecef ;*/
                border-radius: 100%;
            }
            .treble[shadow]{
                height:7.3vh;
                width:7.3vh;
            }
            .bass_chord[shadow] , .bass_note[shadow] {
                height:5.8vh;
                width:5.8vh;
            }
        </style>
        <!-- local DOM -->
        <template is="dom-if" if="[[done]]" >
            <div shadow class$="{{buttonType}}">
                <div circle class$="{{buttonType}}" style$="background-color:{{_computeColor(state)}} ;">
                </div>
            </div>
        </template>
    </template>
    <script>
        Polymer({
            is: "accordion-button",
            observers: [],
            behaviors: [],
            listeners: {
                'mousedown':'_buttonPress',
                'mouseup':'_buttonRelease'
            },
            properties: {
                loadCnt:{
                    type:Number,
                    value:0
                },
                done:{
                    type:Boolean,
                    value:false
                },
                text: {
                    type: String,
                    value: ""
                },
                state: {
                    type: Number
                },
                previousState: {
                    type: Number
                },
                buttonType: {
                    type: String
                },
                source: {
                    type: Object
                },
                sourceGain: {
                    type: Object
                },
                closeBuffer:{
                    type:Object
                },
                closeIndex: {
                    type: Number
                },
                closeLoopDuration:{
                    type:Number
                },
                openBuffer:{
                    type:Object
                },
                openIndex: {
                    type: Number
                },
                openLoopDuration:{
                    type:Number
                }
            },
            _buttonPress: function(){
                this.state = 1 ;
            },
            _buttonRelease: function(){
                this.state = 0 ;
            },
            _playNote: function () {
                if (this.state !== this.previousState) {
                    this._stopSource();
                    this.source = context.createBufferSource();
                    var loopDuration ;
                    if ( this.state === 1 ) {
                        loopDuration = this.closeLoopDuration ;
                        this.source.buffer = this.closeBuffer ;
                    }
                    else if ( this.state ===2 ){
                        loopDuration = this.openLoopDuration ;
                        this.source.buffer = this.openBuffer ;
                    }
                    this.source.loopStart = this.source.buffer.duration - loopDuration;
                    this.source.loopEnd = this.source.buffer.duration;
                    this.sourceGain = context.createGain();
                    this.source.connect(this.sourceGain);
                    this.source.loop = true;
                    this.sourceGain.connect(compressor);
                    this.source.start(0);
                }
            },
            _stopSource: function () {
                if (this.source !== undefined) {
                    this.sourceGain.gain.exponentialRampToValueAtTime(0.01, context.currentTime + 0.03);
                    this.source.stop(context.currentTime + 0.03);
                }
            },
            _computeColor: function (state) {
                switch (state) {
                    case 0:
                        if (this.done) {
                            this._stopSource();
                            this.previousState = state;
                        }
                        return 'white';
                    case 1:
                        if( this.done ) {
                            this._playNote();
                            this.previousState = state;
                        }
                        return '#4775D1';
                    case 2:
                        if ( this.done) {
                            this._playNote();
                            this.previousState = state;
                        }
                        return '#CC6666';
                }
            },
            _extractBuffer:function(src, offset, length) {
                var dstU8 = new Uint8Array(length);
                var srcU8 = new Uint8Array(src, offset, length);
                dstU8.set(srcU8);
                return dstU8;
            },
            _loadNotes: function(){
                var close_url , open_url ;
                if ( this.buttonType === "treble"){
                    close_url = "/data/accordion_synth/treble2/"+ this.closeIndex + "c.mp3" ;
                    open_url = "/data/accordion_synth/treble2/" + this.openIndex + "c.mp3" ;
                }
                if ( this.buttonType === "bass_note"){
                    close_url = "/data/accordion_synth/bass_notes/" + this.closeIndex + "c.mp3" ;
                    open_url = "/data/accordion_synth/bass_notes/" + this.openIndex + "c.mp3" ;
                }
                if ( this.buttonType === "bass_chord"){
                    close_url = "/data/accordion_synth/bass_chords/" + this.closeIndex + "c.mp3" ;
                    open_url = "/data/accordion_synth/bass_chords/" + this.openIndex + "c.mp3" ;
                }

                var closeIndexRequest = new XMLHttpRequest();
                closeIndexRequest.open('GET', close_url, true);
                closeIndexRequest.responseType = 'arraybuffer';
                closeIndexRequest.onload = function() {
                    var data = closeIndexRequest.response ;
                    var bb = new DataView(data);
                    this.closeLoopDuration = bb.getFloat32(0, true);
                    var length = bb.getUint32(4, true);
                    var sound = this._extractBuffer(data, 8, length);
                    context.decodeAudioData(sound.buffer, function(buffer) {
                        this.closeBuffer = buffer;
                        loadCnt++ ;
                        if ( loadCnt === 86 ) {
                            var d = new Date ( ) ;
                            loadTime = d.getTime()-loadTime;
                            loadTime /=1000 ;
                            console.log( loadTime );
                        }
                        this.loadCnt ++ ;
                        if( this.loadCnt ===2 ) {
                            this.done = true ;
                        }
                    }.bind(this));
                }.bind(this);
                closeIndexRequest.send();

                var openIndexRequest = new XMLHttpRequest();
                openIndexRequest.open('GET', open_url, true);
                openIndexRequest.responseType = 'arraybuffer';
                openIndexRequest.onload = function() {
                    var data = openIndexRequest.response ;
                    var bb = new DataView(data);
                    this.openLoopDuration = bb.getFloat32(0, true);
                    var length = bb.getUint32(4, true);
                    var sound = this._extractBuffer(data, 8, length);
                    context.decodeAudioData(sound.buffer, function(buffer) {
                        this.openBuffer = buffer;
                        loadCnt++ ;
                        if ( loadCnt === 86 ) {
                            var d = new Date ( ) ;
                            loadTime = d.getTime()-loadTime;
                            loadTime /=1000 ;
                            console.log( loadTime );
                        }
                        this.loadCnt ++ ;
                        if( this.loadCnt ===2 ) {
                            this.done = true ;
                        }
                    }.bind(this));
                }.bind(this);
                openIndexRequest.send();
            },
            ready: function () {
                Polymer.RenderStatus.afterNextRender(this, function () {
                    if (!this.state) {
                        this.state = 0;
                    }
                    if ( loadTime === -1 ) {
                        var d = new Date ( ) ;
                        loadTime = d.getTime() ;
                        loadCnt = 0 ;
                    }
                    this._loadNotes() ;
                });
            }
        });
    </script>
</dom-module>

p<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../iron-image/iron-image.html">
<!--

Shows drop down menu (works on chrome)

### Usage
The list displayed in the drop down menu can be set as an attribute.

    <drop-menu list-items='["first" ,"second"]'></drop-menu>

For an overlayed drop menu:

    <drop-menu overlay-menu list-items='["first" ,"second"]'></drop-menu>

### Styling
 Custom property | Description | Default
----------------|-------------|----------
`--item-background-color` | List item backround color | `#f1ecef`
`--item-color` | List item color used for fonts | `#302f31`
`--close-color` | Icon button hover color | `4775D1`
`--content-background` | Drop menu's background color | `white`
`--close-color` | Icon button hover color | `4775D1`
`--icon-button` | Mixin applied the icon button | `{}`

@demo demo/drop-menu-demo.html
-->
<dom-module id="accordion-button">
    <template>
        <style>
            :host {}
            .bass_chord {
                margin-top: -0.6vh;
                user-select: none;
                height: 5.4vh;
                width: 5.4vh;
                visibility: hidden;
            }
            [text] {
                height: 100%;
                width: 100%;
                color: white;
                font-weight: bold;
                @apply(--layout-horizontal);
                @apply(--layout-center-justified);
                @apply(--layout-center);
                @apply(--layout-vertical);
            }
            .bass_note {
                margin-top: -0.6vh;
                user-select: none;
                height: 5.4vh;
                width: 5.4vh;
                visibility: hidden;
            }
            .treble {
                user-select: none;
                margin-top: -0.6vh;
                height: 6.8vh;
                width: 6.8vh;
                visibility: hidden;
            }
            [circle] {
                background-color: var(--content-background);
                border-radius: 100%;
            }
            [circle]:hover {
                cursor: pointer;
            }
            [shadow] {
                @apply(--layout-center-justified);
                @apply(--layout-vertical);
                @apply(--layout-center);
                background-color: #e4e4e4;
                /*background-color: #f1ecef ;*/
                border-radius: 100%;
            }
            .treble[shadow] {
                height: 7.1vh;
                width: 7.1vh;
                visibility: visible;
            }
            .bass_chord[shadow],
            .bass_note[shadow] {
                height: 5.8vh;
                width: 5.8vh;
                visibility: visible;
            }
        </style>
        <!-- local DOM -->
        <div shadow class$="{{buttonType}}">
            <div circle class$="{{buttonType}}" style="visibility:visible ;background-color:white; position:absolute;"></div>
            <div circle class$="{{buttonType}}" style$=" visibility:{{_computeVisibility(state)}};background-color:{{_computeColor(state)}}; position:absolute ;">
                <template is="dom-if" if="[[showingNotes]]">
                    <div text>
                        [[note]]
                    </div>
                </template>
            </div>
            <div circle class$="{{buttonType}}" style$="position:absolute; background-color:{{_computeColor2(playbackState)}};visibility:{{_computeVisibility2(playbackState)}};">
                <template is="dom-if" if="[[showingNotes]]">
                    <div text>
                        [[playBackNote]]
                    </div>
                </template>
            </div>
        </div>
    </template>
    <script>
        Polymer({
            is: "accordion-button",
            observers: [],
            behaviors: [],
            listeners: {
                'mousedown': '_buttonPress',
                'mouseup': '_buttonRelease'
            },
            properties: {
                playbackEventQueue: {
                    type: Array,
                    value: []
                },
                instrumentEventQueue: {
                    type: Array,
                    value: []
                },
                showingNotes: {
                    type: Boolean,
                    value: false
                },
                textColor: {
                    type: String,
                    value: ""
                },
                note: {
                    type: String,
                    value: ""
                },
                playBackNote: {
                    type: String,
                    value: ""
                },
                text: {
                    type: String,
                    value: ""
                },
                state: {
                    type: Number
                },
                playbackState: {
                    type: Number
                },
                buttonType: {
                    type: String
                },
                closeIndex: {
                    type: Number
                },
                openIndex: {
                    type: Number
                }
            },
            update: function () {
                var next ;
                while (this.playbackEventQueue.length > 0) {
                    next = this.playbackEventQueue[this.playbackEventQueue.length - 1];
                    if (next.detail.time < context.currentTime) {
                        this.playbackState = next.detail.state;
                        this.playbackEventQueue.pop();
                    } else {
                        break;
                    }
                }
                while (this.instrumentEventQueue.length > 0) {
                    next = this.instrumentEventQueue[this.instrumentEventQueue.length - 1];
                    if (next.detail.time < context.currentTime) {
                        this.state = next.detail.state;
                        this.instrumentEventQueue.pop();
                    } else {
                        break;
                    }
                }
            },
            addButtonAction: function (e) {
                if(e.detail.origin === 'playback')
                    this.playbackEventQueue.unshift(e);
                if(e.detail.origin === 'instrument')
                    this.instrumentEventQueue.unshift(e);
            },
            _buttonPress: function () {
                this.state = 1;
            },
            _buttonRelease: function () {
                this.state = 0;
            },
            _noteNumberToName: function (note) {
                if (this.buttonType === 'bass_chord')
                    return "";
                var notes = [
                    'C',
                    'C#',
                    'D',
                    'Eb',
                    'E',
                    'F',
                    'F#',
                    'G',
                    'Ab',
                    'A',
                    'Bb',
                    'B'
                ];
                var octave = Math.floor(note / 12);
                var name = notes[note % 12];
                name += octave;
                return name;
            },
            _computeColor: function (state) {
                switch (state) {
                    case 0:
                        this.note = "";
                        return 'green';
                    case 1:
                        this.note = this._noteNumberToName(this.closeIndex);
                        return '#4775D1';
                    case 2:
                        this.note = this._noteNumberToName(this.openIndex);
                        return '#CC6666';
                }
            },
            _computeColor2: function (playbackState) {
                switch (playbackState) {
                    case 0:
                        this.playBackNote = "";
                        return 'purple';
                    case 1:
                        this.playBackNote = this._noteNumberToName(this.closeIndex);
                        return '#4775D1';
                    case 2:
                        this.playBackNote = this._noteNumberToName(this.openIndex);
                        return '#CC6666';
                }
            },
            _computeVisibility: function (state) {
                if (state === 0)
                    return 'hidden';
                return 'visible';
            },
            _computeVisibility2: function (playbackState) {
                if (playbackState === 0)
                    return 'hidden';
                return 'visible';
            },
            ready: function () {
                Polymer.RenderStatus.afterNextRender(this, function () {
                    this.playbackEventQueue = [];
                    this.instrumentEventQueue = [];
                    if (!this.state)
                        this.state = 0;
                    }
                );
            }
        });
    </script>
</dom-module>

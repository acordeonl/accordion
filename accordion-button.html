<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../iron-image/iron-image.html">
<!--

Shows drop down menu (works on chrome)

### Usage
The list displayed in the drop down menu can be set as an attribute.

    <drop-menu list-items='["first" ,"second"]'></drop-menu>

For an overlayed drop menu:

    <drop-menu overlay-menu list-items='["first" ,"second"]'></drop-menu>

### Styling
 Custom property | Description | Default
----------------|-------------|----------
`--item-background-color` | List item backround color | `#f1ecef`
`--item-color` | List item color used for fonts | `#302f31`
`--close-color` | Icon button hover color | `4775D1`
`--content-background` | Drop menu's background color | `white`
`--close-color` | Icon button hover color | `4775D1`
`--icon-button` | Mixin applied the icon button | `{}`

@demo demo/drop-menu-demo.html
-->
<dom-module id="accordion-button">
    <template>
        <style>
            :host {}
            .bass_chord {
                margin-top: -0.6vh;
                user-select: none;
                height: 5.4vh;
                width: 5.4vh;
            }
            [text]{
                height:100%;
                width:100%;
                color: white;
                font-weight: bold;
                @apply(--layout-horizontal);
                @apply(--layout-center-justified);
                @apply(--layout-center);
                @apply(--layout-vertical);
            }
            .bass_note {
                margin-top: -0.6vh;
                user-select: none;
                height: 5.4vh;
                width: 5.4vh;
            }
            .treble {
                user-select: none;
                margin-top: -0.6vh;
                height: 6.8vh;
                width: 6.8vh;
            }
            [circle] {
                background-color: var(--content-background);
                border-radius: 100%;
            }
            [circle]:hover {
                cursor: pointer;
            }
            [shadow] {
                @apply(--layout-center-justified);
                @apply(--layout-vertical);
                @apply(--layout-center);
                background-color: #e4e4e4;
                /*background-color: #f1ecef ;*/
                border-radius: 100%;
            }
            .treble[shadow] {
                height: 7.3vh;
                width: 7.3vh;
            }
            .bass_chord[shadow],
            .bass_note[shadow] {
                height: 5.8vh;
                width: 5.8vh;
            }
        </style>
        <!-- local DOM -->
        <template is="dom-if" if="[[done]]">
            <div shadow class$="{{buttonType}}">
                <div circle class$="{{buttonType}}" style$="background-color:{{_computeColor(state)}} ;">
                    <template is="dom-if" if="[[showingNotes]]" >
                        <div text >
                            [[note]]
                        </div>
                    </template>
                </div>
            </div>
        </template>
    </template>
    <script>
        Polymer({
            is: "accordion-button",
            observers: [
                '_loadCloseNote(instrumentUrl, closeIndex)', '_loadOpenNote(instrumentUrl,openIndex)',
                '_changeVolume(sourceGain,buttonVelocity,buttonVolume)'
            ],
            behaviors: [],
            listeners: {
                'mousedown': '_buttonPress',
                'mouseup': '_buttonRelease'
            },
            properties: {
                buttonVelocity:{
                    type:Number
                },
                buttonVolume:{
                    type:Number,
                },
                showingNotes:{
                    type:Boolean,
                    value:false
                },
                textColor:{
                    type:String,
                    value:""
                },
                note:{
                    type:String,
                    value:""
                },
                _loadedCloseNote: {
                    type: Boolean,
                    value: false
                },
                _loadedOpenNote: {
                    type: Boolean,
                    value: false
                },
                instrumentUrl: {
                    type: String
                },
                loadCnt: {
                    type: Number,
                    value: 0
                },
                done: {
                    type: Boolean,
                    value: false
                },
                text: {
                    type: String,
                    value: ""
                },
                state: {
                    type: Number
                },
                previousState: {
                    type: Number
                },
                buttonType: {
                    type: String
                },
                source: {
                    type: Object
                },
                sourceGain: {
                    type: Object
                },
                closeBuffer: {
                    type: Object
                },
                closeIndex: {
                    type: Number
                },
                closeLoopDuration: {
                    type: Number
                },
                openBuffer: {
                    type: Object
                },
                openIndex: {
                    type: Number
                },
                openLoopDuration: {
                    type: Number
                }
            },
            _changeVolume: function(sGain, buttonVelocity, buttonVolume){
                this.sourceGain.gain.value = buttonVelocity*buttonVolume/100 ;
            },
            _buttonPress: function () {
                this.state = 1;
            },
            _buttonRelease: function () {
                this.state = 0;
            },
            _playNote: function () {
                if (this.state !== this.previousState) {
                    this._stopSource();
                    this.source = context.createBufferSource();
                    var loopDuration;
                    if (this.state === 1) {
                        loopDuration = this.closeLoopDuration;
                        this.source.buffer = this.closeBuffer;
                    } else if (this.state === 2) {
                        loopDuration = this.openLoopDuration;
                        this.source.buffer = this.openBuffer;
                    }
                    this.source.loopStart = this.source.buffer.duration - loopDuration;
                    this.source.loopEnd = this.source.buffer.duration;
                    this.sourceGain = context.createGain();
                    this.sourceGain.gain.value = this.buttonVelocity*this.buttonVolume/100 ;
                    this.source.connect(this.sourceGain);
                    this.source.loop = true;
                    this.sourceGain.connect(compressor);
                    this.source.start(0);
                }
            },
            _noteNumberToName: function(note){
                var notes = ['C','C#','D','Eb','E','F','F#','G', 'Ab', 'A', 'Bb','B']  ;
        		var octave = Math.floor(note/12) ;
        		var name = notes[note%12] ;
                if ( this.buttonType !== 'bass_chord')
        		      name+=octave ;
        		return name ;
            },
            _stopSource: function () {
                if (this.source !== undefined) {
                    this.sourceGain.gain.exponentialRampToValueAtTime(0.01, context.currentTime + 0.03);
                    this.source.stop(context.currentTime + 0.03);
                }
            },
            _computeColor: function (state) {
                switch (state) {
                    case 0:
                        if (this.done) {
                            this._stopSource();
                            this.previousState = state;
                        }
                        this.note = "" ;
                        return 'white';
                    case 1:
                        if (this.done) {
                            this._playNote();
                            this.previousState = state;
                        }
                        this.note = this._noteNumberToName(this.closeIndex) ;
                        return '#4775D1';
                    case 2:
                        if (this.done) {
                            this._playNote();
                            this.previousState = state;
                        }
                        this.note = this._noteNumberToName(this.openIndex);

                        return '#CC6666';
                }
            },
            _requestBuffer: function (url, which) {
                if (savedBuffers[url] !== undefined) {
                    if (which === "close") {
                        this.closeBuffer = savedBuffers[url];
                        this._loadedCloseNote = true;
                    } else {
                        this.openBuffer = savedBuffers[url];
                        this._loadedOpenNote = true;
                    }
                    if (this._loadedOpenNote && this._loadedCloseNote) {
                        this.done = true;
                    }
                    return;
                }
                var request = new XMLHttpRequest();
                request.open('GET', url, true);
                request.responseType = 'arraybuffer';
                request.onload = function () {
                    if (request.status === 404) {
                        if (!errorLoading) {
                            this.fire("toast", {msg: 'La tonalidad no pudo ser cargada'});
                            errorLoading = true;
                        }
                        return;
                    }
                    var data = request.response;
                    var bb = new DataView(data);
                    if (which === "close")
                        this.closeLoopDuration = bb.getFloat32(0, true);
                    else
                        this.openLoopDuration = bb.getFloat32(0, true);
                    var length = bb.getUint32(4, true);
                    var dstU8 = new Uint8Array(length);
                    var srcU8 = new Uint8Array(data, 8, length);
                    dstU8.set(srcU8);
                    var sound = dstU8;
                    context.decodeAudioData(sound.buffer, function (buffer) {
                        savedBuffers[url] = buffer;
                        if (which === "close") {
                            this.closeBuffer = buffer;
                            this._loadedCloseNote = true;
                        } else {
                            this.openBuffer = buffer;
                            this._loadedOpenNote = true;
                        }
                        if (this._loadedOpenNote && this._loadedCloseNote) {
                            this.done = true;
                        }
                    }.bind(this));
                }.bind(this);
                request.send();
            },
            _loadCloseNote: function (instrumentUrl, closeIndex) {
                this.state = 0 ;
                this._loadedCloseNote = false;
                this.done = false;
                this._requestBuffer(instrumentUrl + "/" + closeIndex + "c.mp3", "close");
            },
            _loadOpenNote: function (instrumentUrl, openIndex) {
                this.state = 0 ;
                this._loadedOpenNote = false;
                this.done = false;
                this._requestBuffer(instrumentUrl + "/" + openIndex + "c.mp3", "open");
            },
            ready: function () {
                Polymer.RenderStatus.afterNextRender(this, function () {
                    if (!this.state)
                        this.state = 0;
                    }
                );
            }
        });
    </script>
</dom-module>

<link rel="import" href="/bower_components/polymer/polymer.html">
<dom-module id="notes-loader">
    <template>
        <style>
            :host {
            }
        </style>

    </template>
    <script>
        Polymer({
            is: "notes-loader",
            observers: [],
            behaviors:[],
            listeners: {},
            properties: {
                done:{
                    type:Number,
                    value:0
                },
                treblePos:{
                    type:Number,
                    value:0
                },
                bassNPos:{
                    type:Number,
                    value:0
                },
                bassCPos:{
                    type:Number,
                    value:0
                },
                treble_data:{
                    type:Object
                },
                treble_bb:{
                    type:Object
                },
                treble_offset:{
                    type:Number,
                    value:0
                },
                bassN_data:{
                    type:Object
                },
                bassN_bb:{
                    type:Object
                },
                bassN_offset:{
                    type:Number,
                    value:0
                },
                bassC_data:{
                    type:Object
                },
                bassC_bb:{
                    type:Object
                },
                bassC_offset:{
                    type:Number,
                    value:0
                }
            },
            _extractBuffer:function(src, offset2, length2) {
                var dstU8 = new Uint8Array(length2);
                var srcU8 = new Uint8Array(src, offset2, length2);
                dstU8.set(srcU8);
                return dstU8;
            },
            _processTrebleConcatenatedFile: function() {
                if (this.treble_offset >= this.treble_bb.byteLength) {
                    this.done ++ ;
                    if( this.done === 3 )
                        this.fire( 'done') ;
                    return ;
                }
                var length = this.treble_bb.getUint32(this.treble_offset, true);
                this.treble_offset += 4;
                var sound = this._extractBuffer(this.treble_data, this.treble_offset, length);
                this.treble_offset += length;
                context.decodeAudioData(sound.buffer, function(res) {
                    treble_buffers[this.treblePos] = res ;
                    this.treblePos ++ ;
                    this._processTrebleConcatenatedFile() ;
                }.bind(this)) ;
            },
            _processBassNConcatenatedFile: function() {
                if (this.bassN_offset >= this.bassN_bb.byteLength) {
                    this.done ++ ;
                    if( this.done === 3 )
                        this.fire( 'done') ;
                    return ;
                }
                var length = this.bassN_bb.getUint32(this.bassN_offset, true);
                this.bassN_offset += 4;
                var sound = this._extractBuffer(this.bassN_data, this.bassN_offset, length);
                this.bassN_offset += length;
                context.decodeAudioData(sound.buffer, function(res) {
                    bassN_buffers[this.bassNPos] = res ;
                    this.bassNPos ++ ;
                    this._processBassNConcatenatedFile() ;
                }.bind(this)) ;
            },
            _processBassCConcatenatedFile: function() {
                if (this.bassC_offset >= this.bassC_bb.byteLength) {
                    this.done ++ ;
                    if( this.done === 3 )
                        this.fire( 'done') ;
                    return ;
                }
                var length = this.bassC_bb.getUint32(this.bassC_offset, true);
                this.bassC_offset += 4;
                var sound = this._extractBuffer(this.bassC_data, this.bassC_offset, length);
                this.bassC_offset += length;
                context.decodeAudioData(sound.buffer, function(res) {
                    bassC_buffers[this.bassCPos] = res ;
                    this.bassCPos ++ ;
                    this._processBassCConcatenatedFile() ;
                }.bind(this)) ;
            },
            requestTrebleNotes: function(url){
                this.treblePos= treble_startNote ;
                var notesRequest = new XMLHttpRequest();
                notesRequest.open('GET', url, true);
                notesRequest.responseType = 'arraybuffer';
                notesRequest.onload = function() {
                    this.treble_data = notesRequest.response ;
                    this.treble_bb = new DataView(this.treble_data);
                    this._processTrebleConcatenatedFile();
                }.bind(this);
                notesRequest.send();
            },
            requestBassNNotes: function(url){
                this.bassNPos = 0 ;
                var notesRequest = new XMLHttpRequest();
                notesRequest.open('GET', url, true);
                notesRequest.responseType = 'arraybuffer';
                notesRequest.onload = function() {
                    this.bassN_data = notesRequest.response ;
                    this.bassN_bb = new DataView(this.bassN_data);
                    this._processBassNConcatenatedFile();
                }.bind(this);
                notesRequest.send();
            },
            requestBassCNotes: function(url){
                this.bassCPos = 0 ;
                var notesRequest = new XMLHttpRequest();
                notesRequest.open('GET', url, true);
                notesRequest.responseType = 'arraybuffer';
                notesRequest.onload = function() {
                    this.bassC_data = notesRequest.response ;
                    this.bassC_bb = new DataView(this.bassC_data);
                    this._processBassCConcatenatedFile();
                }.bind(this);
                notesRequest.send();
            },
            requestConvolver: function(url){
                var convolverRequest = new XMLHttpRequest();
                convolverRequest.open('GET', url, true);
                convolverRequest.responseType = 'arraybuffer';
                convolverRequest.onload = function() {
                    context.decodeAudioData(convolverRequest.response, function(buffer) {
                        convolver.buffer = buffer;
                    });
                };
                convolverRequest.send();
            },
            ready: function () {
                Polymer.RenderStatus.afterNextRender(this, function(){
                    var d = new Date ( ) ;
                    loadTime = d.getTime() ;
                    this.requestConvolver("/data/16_IR_Pool_Size_00.wav") ;
                    this.requestTrebleNotes("/data/treble_hq_stereo.mp3") ;
                    this.requestBassNNotes("/data/bass_notes_hq_stereo.mp3") ;
                    this.requestBassCNotes("/data/bass_chords_hq_stereo.mp3") ;
                }) ;
            }
        });
    </script>
</dom-module>

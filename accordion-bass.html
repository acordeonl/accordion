l<imports >
    <link rel="import" href="../polymer/polymer.html">
    <link rel="import" href="../animation-behaviors/scale-up-behavior.html">
    <link rel="import" href="./accordion-buttons-behavior.html">
    <link rel="import" href="../ac-instrument-behaviors/instrument-buttons-behavior.html">
    <link rel="import" href="../local-dom/local-dom.html" async>
    <link rel="import" href="./accordion-button.html" async>
    <link rel="import" href="../ac-synthesizer/ac-synthesizer.html">
</imports>
<!--

Shows drop down menu (works on chrome)

### Usage
The list displayed in the drop down menu can be set as an attribute.

    <drop-menu list-items='["first" ,"second"]'></drop-menu>

For an overlayed drop menu:

    <drop-menu overlay-menu list-items='["first" ,"second"]'></drop-menu>

### Styling
 Custom property | Description | Default
----------------|-------------|----------
`--item-background-color` | List item backround color | `#f1ecef`
`--item-color` | List item color used for fonts | `#302f31`
`--button-close-color` | Icon button hover color | `4775D1`
`--button-background-color` | Drop menu's background color | `white`
`--button-close-color` | Icon button hover color | `4775D1`
`--icon-button` | Mixin applied the icon button | `{}`

@demo demo/drop-menu-demo.html
-->
<dom-module id="accordion-bass">
    <template>
        <style>
            :host {}
            local-dom {
                height: 100vh;
                @apply(--layout-center);
                @apply(--layout-justified);
            }
            .col {
                padding: 1.3vw;
                height: 51vh;
                @apply(--layout-justified);
            }
            [mobile] #col {
                padding: 1.8vw;
            }
            [tablet] #col {
                padding: 1.2vw;
            }
            .vertical {
                @apply(--layout-vertical);
            }
            .reversedVertical {
                @apply(--layout-vertical-reverse);
            }
            .reversedHorizontal {
                @apply(--layout-horizontal-reverse);
            }
            .horizontal {
                @apply(--layout-horizontal);
            }
        </style>
        <!-- local DOM -->
        <ac-synthesizer instrument-velocity=[[instrumentVelocity]] instrument-gain=[[instrumentVolume]] playback-gain=[[playbackVolume]] id="bassNotesSynthesizer" instrument-url="/data/accordion_synth/bass_notes"></ac-synthesizer>
        <ac-synthesizer instrument-velocity=[[instrumentVelocity]] instrument-gain=[[instrumentVolume]] playback-gain=[[playbackVolume]] id="bassChordsSynthesizer" instrument-url="/data/accordion_synth/bass_chords"></ac-synthesizer>
        <local-dom mobile="{{mobile}}" tablet="{{tablet}}" laptop="{{laptop}}" class$="{{_computeRotation(rotation)}}">
            <div class$="col {{_computeColRotation(rotation)}}">
                <accordion-button button idChord3 close-index="[[chordsCloseIndex.3]]" open-index="[[chordsOpenIndex.3]]" button-type="bass_chord"></accordion-button>
                <accordion-button button id3 close-index="[[closeIndex.3]]" open-index="[[openIndex.3]]" button-type="bass_note"></accordion-button>
                <accordion-button button idChord4 close-index="[[chordsCloseIndex.4]]" open-index="[[chordsOpenIndex.4]]" button-type="bass_chord"></accordion-button>
                <accordion-button button id4 close-index="[[closeIndex.4]]" open-index="[[openIndex.4]]" button-type="bass_note"></accordion-button>
                <accordion-button button idChord5 close-index="[[chordsCloseIndex.5]]" open-index="[[chordsOpenIndex.5]]" button-type="bass_chord"></accordion-button>
                <accordion-button button id5 close-index="[[closeIndex.5]]" open-index="[[openIndex.5]]" button-type="bass_note"></accordion-button>
            </div>
            <div class$="col {{_computeColRotation(rotation)}}">
                <accordion-button button idChord0 close-index="[[chordsCloseIndex.0]]" open-index="[[chordsOpenIndex.0]]" button-type="bass_chord"></accordion-button>
                <accordion-button button id0 close-index="[[closeIndex.0]]" open-index="[[openIndex.0]]" button-type="bass_note"></accordion-button>
                <accordion-button button idChord1 close-index="[[chordsCloseIndex.1]]" open-index="[[chordsOpenIndex.1]]" button-type="bass_chord"></accordion-button>
                <accordion-button button id1 close-index="[[closeIndex.1]]" open-index="[[openIndex.1]]" button-type="bass_note"></accordion-button>
                <accordion-button button idChord2 close-index="[[chordsCloseIndex.2]]" open-index="[[chordsOpenIndex.2]]" button-type="bass_chord"></accordion-button>
                <accordion-button button id2 close-index="[[closeIndex.2]]" open-index="[[openIndex.2]]" button-type="bass_note"></accordion-button>
            </div>
        </local-dom>
    </template>
    <script>
        Polymer({
            is: "accordion-bass",
            observers: ['_swap(showingTreble)'],
            listeners: {},
            behaviors: [InstrumentButtonsBehavior,ScaleUpBehavior,AccordionButtonsBehavior],
            /* ./accordion-buttons-behavior.html
               ../ac-instrument-behaviors/instrument-buttons-behavior.html
            */
            properties: {
                closeIndex: {
                    type: Array,
                    value: []
                },
                openIndex: {
                    type: Array,
                    value: []
                },
                chordsCloseIndex: {
                    type: Array,
                    value: []
                },
                chordsOpenIndex: {
                    type: Array,
                    value: []
                },
            },
            _loadNotes: function () {
                var i;
                for (i = 0; i < 6; i++) {
                    this.$.bassNotesSynthesizer._loadNote(this.closeIndex[i]);
                    this.$.bassNotesSynthesizer._loadNote(this.openIndex[i]);
                    this.$.bassChordsSynthesizer._loadNote(this.chordsCloseIndex[i]);
                    this.$.bassChordsSynthesizer._loadNote(this.chordsOpenIndex[i]);
                }
            },
            addButtonAction: function (e) {
                var note,which,button=e.detail.midiNote;
                e.detail.buttonState = 0 ;
                if (e.detail.channel === 3) {
                    which = Math.floor(button / 2);
                    if (e.detail.cmd === 'note-on') {
                        e.detail.buttonState = (button % 2) + 1 ;
                        note = (button % 2) ? this.chordsOpenIndex[which]: this.chordsCloseIndex[which];
                        this.$.bassChordsSynthesizer._startButtonAudio(note, button, e);
                    }
                    else
                        this.$.bassChordsSynthesizer._stopButtonAudio(button, e);
                    this.$$("[idChord" + which + "]").addButtonAction(e);
                }
                else {
                // if(e.detail.channel !== 3) {
                    button -= 48;
                    which = Math.floor(button / 2);
                    if (e.detail.cmd === 'note-on') {
                        e.detail.buttonState = (button % 2) + 1 ;
                        note = (button % 2) ? this.openIndex[which]: this.closeIndex[which];
                        this.$.bassNotesSynthesizer._startButtonAudio(note, button, e);
                    }
                    else
                        this.$.bassNotesSynthesizer._stopButtonAudio(button, e);
                    this.$$("[id" + which + "]").addButtonAction(e);
                }
            },
            changePitch: function (pitch) {
                this._changeChordsPitch(pitch);
                this._changeBassNotesPitch(pitch);
            },
            _checkBassNotes: function (note) {
                if (note > 59)
                    return note - 60 + 48;
                else if (note < 48)
                    return 59 - 47 + note;
                return note;
            },
            _changeBassNotesPitch: function (pitch) {
                var subs = false;
                if (pitch < 0) {
                    subs = true;
                    pitch *= -1;
                }
                for (var i = 0; i < 6; i++) {
                    if (!subs) {
                        this.closeIndex[i] += (pitch % 12);
                        this.openIndex[i] += (pitch % 12);
                    } else {
                        this.closeIndex[i] -= (pitch % 12);
                        this.openIndex[i] -= (pitch % 12);
                    }
                    this.closeIndex[i] = this._checkBassNotes(this.closeIndex[i]);
                    this.openIndex[i] = this._checkBassNotes(this.openIndex[i]);
                }
                this._updateIndexes();
            },
            _changeChordsPitch: function (pitch) {
                if (pitch === 0) {
                    this._updateChordIndexes();
                    return;
                }
                for (var i = 0; i < 42; i++) {
                    if (pitch > 0) {
                        this.chordsCloseIndex[i] = bassChordsNextNote[this.chordsCloseIndex[i]];
                        this.chordsOpenIndex[i] = bassChordsNextNote[this.chordsOpenIndex[i]];
                    } else {
                        this.chordsCloseIndex[i] = bassChordspreviousNote[this.chordsCloseIndex[i]];
                        this.chordsOpenIndex[i] = bassChordspreviousNote[this.chordsOpenIndex[i]];
                    }
                }
                if (pitch > 0)
                    this._changeChordsPitch(pitch - 1);
                else {
                    this._changeChordsPitch(pitch + 1);
                }
            },
            _swap: function (showingTreble) {
                if (!showingTreble) {
                    this.playAnimation('entry');
                }
            },
            ready: function () {
                this.closeIndex[0] = 55;
                this.closeIndex[1] = 48;
                this.closeIndex[2] = 53;
                this.closeIndex[3] = 52;
                this.closeIndex[4] = 57;
                this.closeIndex[5] = 58;
                this.openIndex[0] = 50;
                this.openIndex[1] = 55;
                this.openIndex[2] = 48;
                this.openIndex[3] = 57;
                this.openIndex[4] = 50;
                this.openIndex[5] = 58;
                this.chordsCloseIndex[0] = 35;
                this.chordsCloseIndex[1] = 15;
                this.chordsCloseIndex[2] = 22;
                this.chordsCloseIndex[3] = 41;
                this.chordsCloseIndex[4] = 5;
                this.chordsCloseIndex[5] = 9;
                this.chordsOpenIndex[0] = 26;
                this.chordsOpenIndex[1] = 35;
                this.chordsOpenIndex[2] = 15;
                this.chordsOpenIndex[3] = 3;
                this.chordsOpenIndex[4] = 24;
                this.chordsOpenIndex[5] = 9;
                this._loadNotes();
                this.changePitch(this.tone);
                // this.playAnimation('entry') ;
            }
        });
    </script>
</dom-module>
